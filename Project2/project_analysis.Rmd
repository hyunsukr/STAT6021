---
title: "Project"
author: "Hyun Suk (Max) Ryoo (hr2ee)"
date: "11/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
## Data Processing
library(tidyverse)
library(dplyr)
library(MASS)
library(leaps)
setwd("/Users/maxryoo/Documents/MSDS/STAT6021/Project2")
data <- read.csv("data/insurance.csv")
head(data)
```

```{r}
data$significant.charge = as.factor(data$charges > median(data$charges))
head(data)
```
```{r}
ggplot(aes(x=bmi, y=charges, color=smoker), data=data) + 
  labs(title="Scatter Plot of Charges vs BMI by Smoker Status") +
  theme_bw() +
  geom_point()
```

```{r}
ggplot(aes(x=age,y=charges, color=smoker, size=bmi), data=data) + 
  labs(title="Scatter plot of Charges vs Age by BMI and Smoker Status") +
  theme_bw() +
  geom_point(alpha=0.5)
```

```{r}
ggplot(aes(x=age,y=bmi, color=significant.charge), data=data) + 
  labs(title="Scatter plot of Charges vs Age by BMI and Smoker Status") +
  theme_bw() +
  geom_point(alpha=0.5)
```

```{r}
ggplot(data, aes(x=region, y=age, fill=as.factor(significant.charge)))+
  geom_boxplot() +
  theme_bw() +
  labs(x="region", y="ages", title="Dist of bmi by region and smoker status")
```

```{r}
ggplot(data, aes(x=smoker, y=bmi, fill=as.factor(significant.charge)))+
  geom_boxplot() +
  theme_bw() +
  labs(x="Region", y="bmi", title="Distribution of bmi by region and smoker status") +  scale_y_continuous(limits=c(10,60), breaks=seq(10,60,5)) 
```


## Correlation

```{r}
pairs(data[c("age", "bmi", "charges")])
```

```{r}
round(cor(data[c("age", "bmi", "charges")]),4)
```
## All possible regressions and pull based on adjusted R square, mallow, and BIC

```{r}
no_class_predictor = data[1:7]
allreg2 <- regsubsets(charges ~., data=no_class_predictor, nbest=2)
summary(allreg2)
```

## Best for Adjusted R square
```{r}
coef(allreg2, which.max(summary(allreg2)$adjr2))
```

## Best for Mallows 
```{r}
coef(allreg2, which.min(summary(allreg2)$cp))
```

## Best for BIC
```{r}
coef(allreg2, which.min(summary(allreg2)$bic))
```


## Forward Selection
```{r}
##intercept only model
regnull <- lm(charges~1, data=no_class_predictor)
##model with all predictors
regfull <- lm(charges ~ . , data=no_class_predictor)
```

Forward Selection
```{r}
step(regnull, scope=list(lower=regnull, upper=regfull), direction="forward")
```
    (Intercept)             age             bmi        children       smokeryes regionsoutheast 
    -12165.3824        257.0064        338.6413        471.5441      23843.8749       -858.4696 
regionsouthwest 
      -782.7452 
## Backwards
```{r}
step(regfull, scope=list(lower=regnull, upper=regfull), direction="backward")
```


## Based on forward and backward 

We get the same model for forward and backward

Let's first make a multiple linear regression model with all the predictors.

```{r}
mlr_full = lm(charges ~  age + bmi + children + smoker + region, data=no_class_predictor)
summary(mlr_full)
```
The full regression is as follows.

$$
\hat{y} = -11938.5 + 256.9\text{age} -131.3I_1 + 339.2\text{bmi} + 475.5\text{children} + 23848.5I_2 - 353.0I_3 - 1035.0I_4 - 960.0I_5
$$

$I_1$ indicates whether the sex of the client is male. The value will be 0 for females. $I_2$ indicates whether that a client smokes. The value will be 0 for non smokers. $I_3$ indicates that the client is in the northwest region. $I_4$ indicates that the client is located in the southeast. $I_5$ indicates that the client is located inthe southwest. If the client is in the northeast $I_3, I_4, I_5$ will be zero, since this is the reference class. 

## Assumption Check of Full Model
```{r}
yhat_full <- mlr_full$fitted.values
res_full <- mlr_full$residuals
data %>%
  ggplot(aes(yhat_full, res_full)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

The residuals are obviously not evenly scattered, which then we can utilize the boxcox method to give us information about transformation.

```{r}
boxcox(mlr_full, lambda=seq(0,0.3, 0.01))
```

From the boxcox we can try a lambda value of 0.15 for transformation.

```{r}
first_transformation_full <- data
first_transformation_full$charges <- first_transformation_full$charges^0.15
mlr_transform_first <- lm(charges ~ . - significant.charge, data=first_transformation_full)
summary(mlr_transform_first)
```

Residual Plot of the transformed model.

```{r}
yhat_full_t1 <- mlr_transform_first$fitted.values
res_full_t1 <- mlr_transform_first$residuals
data %>%
  ggplot(aes(yhat_full_t1, res_full_t1)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

```{r}
boxcox(mlr_transform_first, lambda=seq(0,3, 0.01))
```


## Without Region

```{r}
mlr_no_region = lm(charges ~  age + bmi + children + smoker, data=no_class_predictor)
summary(mlr_no_region)
```

Residual Plot
```{r}
yhat_no_region <- mlr_no_region$fitted.values
res_no_region <- mlr_no_region$residuals
data %>%
  ggplot(aes(yhat_no_region, res_no_region)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

```{r}
boxcox(mlr_no_region, lambda=seq(-0.2,0.2, 0.01))
```

```{r}
first_transformation_no_region <- no_class_predictor
first_transformation_no_region$charges <- first_transformation_no_region$charges^0.15
mlr_transform_first_no_region <- lm(charges ~ . - region , data=first_transformation_no_region)
summary(mlr_transform_first_no_region)
```

Residual Plot

```{r}
yhat_no_region <- mlr_transform_first_no_region$fitted.values
res_no_region <- mlr_transform_first_no_region$residuals
data %>%
  ggplot(aes(yhat_no_region, res_no_region)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

Box Cox
```{r}
boxcox(mlr_transform_first_no_region, lambda=seq(-0,2, 0.01))
```


```{r}
first_transformation_no_region_log <- first_transformation_no_region
first_transformation_no_region_log$charges <- log(first_transformation_no_region_log$charges)
mlr_transform_first_no_region_log <- lm(charges ~ . - region , data=first_transformation_no_region_log)
summary(mlr_transform_first_no_region_log)
```

Residual Plot

```{r}
yhat_no_region <- mlr_transform_first_no_region_log$fitted.values
res_no_region <- mlr_transform_first_no_region_log$residuals
data %>%
  ggplot(aes(yhat_no_region, res_no_region)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```


Interaction Terms

```{r}
dropped_sign <- data[1:7]
interaction1 <- lm( charges ~ (age + sex + bmi + children + region) * smoker, data = dropped_sign)
without_inter <- lm( charges ~ age + sex + bmi + children + region + smoker, data = dropped_sign)
anova(without_inter, interaction)
interaction2 <- lm( charges ~ (bmi) * smoker + children  + region + age, data = dropped_sign)
anova(interaction2, interaction1)
```

```{r}
summary(interaction2)
```


Residual Plot
```{r}
yhat_drop_inter <- interaction2$fitted.values
res_drop_inter <- interaction2$residuals
data %>%
  ggplot(aes(yhat_drop_inter, res_drop_inter)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

```{r}
boxcox(interaction2, lambda=seq(-0,0.4, 0.01))
```

Lets try adding interaction term

```{r}
interaction2
interaction3 <- lm( charges ~ (bmi + age) * smoker + children  + region, data = dropped_sign)
summary(interaction3)
anova(interaction2, interaction3)
```


Woops lets just go with the model

```{r}
first_transform_interaction <- dropped_sign
first_transform_interaction$charges <- first_transform_interaction$charges^(0.25)
mlr_interaction_transform <- lm( charges ~ (bmi) * smoker + children  + region + age, data = first_transform_interaction)
summary(mlr_interaction_transform)
```

Residual
```{r}
yhat_drop_inter <- mlr_interaction_transform$fitted.values
res_drop_inter <- mlr_interaction_transform$residuals
data %>%
  ggplot(aes(yhat_drop_inter, res_drop_inter)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```


## BIC since nothing works lmAO

```{r}
model3_full <- lm( charges ~ bmi * smoker  * region + children + age, data = dropped_sign)
model3_reduced <- lm( charges ~ bmi * smoker + children + age, data = dropped_sign)
summary(model3_full)
anova(model3_reduced, model3_full)
```

Residual plots

```{r}
yhat_drop_inter <- model3_full$fitted.values
res_drop_inter <- model3_full$residuals
data %>%
  ggplot(aes(yhat_drop_inter, res_drop_inter)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```



```{r}
bic_model <- lm(charges ~ age + bmi + children + smoker, data = data)
summary(bic_model)
```

```{r}
yhat_bic <- bic_model$fitted.values
res_bic <- bic_model$residuals
data %>%
  ggplot(aes(yhat_bic, res_bic)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

```{r}
bic_model_interaction <- lm(charges ~ (age+ bmi + children)*smoker, data = data)
anova(bic_model, bic_model_interaction)
```

```{r}
bic_model_interaction2 <- lm(charges ~ (bmi) *smoker + children, data = data)
anova(bic_model, bic_model_interaction2)
```




