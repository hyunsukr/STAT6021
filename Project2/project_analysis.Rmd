---
title: "Project"
author: "Hyun Suk (Max) Ryoo (hr2ee)"
date: "11/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
## Data Processing
library(tidyverse)
library(dplyr)
library(MASS)
library(leaps)
setwd("/Users/maxryoo/Documents/MSDS/STAT6021/Project2")
data <- read.csv("data/insurance.csv")
head(data)
```

```{r}
data$significant.charge = as.factor(data$charges > median(data$charges))
head(data)
```
```{r}
ggplot(aes(x=bmi, y=charges, color=smoker), data=data) + 
  labs(title="Scatter Plot of Charges vs BMI by Smoker Status") +
  theme_bw() +
  geom_point()
```

```{r}
ggplot(aes(x=age,y=charges, color=smoker, size=bmi), data=data) + 
  labs(title="Scatter plot of Charges vs Age by BMI and Smoker Status") +
  theme_bw() +
  geom_point(alpha=0.5)
```

```{r}
ggplot(aes(x=age,y=bmi, color=significant.charge), data=data) + 
  labs(title="Scatter plot of Charges vs Age by BMI and Smoker Status") +
  theme_bw() +
  geom_point(alpha=0.5)
```

```{r}
ggplot(data, aes(x=region, y=age, fill=as.factor(significant.charge)))+
  geom_boxplot() +
  theme_bw() +
  labs(x="region", y="ages", title="Dist of bmi by region and smoker status")
```

```{r}
ggplot(data, aes(x=smoker, y=bmi, fill=as.factor(significant.charge)))+
  geom_boxplot() +
  theme_bw() +
  labs(x="Region", y="bmi", title="Distribution of bmi by region and smoker status") +  scale_y_continuous(limits=c(10,60), breaks=seq(10,60,5)) 
```


## Correlation

```{r}
pairs(data[c("age", "bmi", "charges")])
```

```{r}
round(cor(data[c("age", "bmi", "charges")]),4)
```
## All possible regressions and pull based on adjusted R square, mallow, and BIC

```{r}
no_class_predictor = data[1:7]
allreg2 <- regsubsets(charges ~., data=no_class_predictor, nbest=2)
summary(allreg2)
```

## Best for Adjusted R square
```{r}
coef(allreg2, which.max(summary(allreg2)$adjr2))
```

## Best for Mallows 
```{r}
coef(allreg2, which.min(summary(allreg2)$cp))
```

## Best for BIC
```{r}
coef(allreg2, which.min(summary(allreg2)$bic))
```


## Forward Selection
```{r}
##intercept only model
regnull <- lm(charges~1, data=no_class_predictor)
##model with all predictors
regfull <- lm(charges ~ . , data=no_class_predictor)
```

Forward Selection
```{r}
step(regnull, scope=list(lower=regnull, upper=regfull), direction="forward")
```

## Backwards
```{r}
step(regfull, scope=list(lower=regnull, upper=regfull), direction="backward")
```


## Based on forward and backward 

We get the same model for forward and backward

Let's first make a multiple linear regression model with all the predictors.

```{r}
mlr_full = lm(charges ~  age + bmi + children + smoker + region, data=no_class_predictor)
summary(mlr_full)
```
The full regression is as follows.

$$
\hat{y} = -11938.5 + 256.9\text{age} -131.3I_1 + 339.2\text{bmi} + 475.5\text{children} + 23848.5I_2 - 353.0I_3 - 1035.0I_4 - 960.0I_5
$$

$I_1$ indicates whether the sex of the client is male. The value will be 0 for females. $I_2$ indicates whether that a client smokes. The value will be 0 for non smokers. $I_3$ indicates that the client is in the northwest region. $I_4$ indicates that the client is located in the southeast. $I_5$ indicates that the client is located inthe southwest. If the client is in the northeast $I_3, I_4, I_5$ will be zero, since this is the reference class. 

## Assumption Check of Full Model
```{r}
yhat_full <- mlr_full$fitted.values
res_full <- mlr_full$residuals
data %>%
  ggplot(aes(yhat_full, res_full)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

The residuals are obviously not evenly scattered, which then we can utilize the boxcox method to give us information about transformation.

```{r}
boxcox(mlr_full, lambda=seq(0,0.3, 0.01))
```

From the boxcox we can try a lambda value of 0.15 for transformation.

```{r}
first_transformation_full <- data
first_transformation_full$charges <- first_transformation_full$charges^0.15
mlr_transform_first <- lm(charges ~ . - significant.charge, data=first_transformation_full)
summary(mlr_transform_first)
```

Residual Plot of the transformed model.

```{r}
yhat_full_t1 <- mlr_transform_first$fitted.values
res_full_t1 <- mlr_transform_first$residuals
data %>%
  ggplot(aes(yhat_full_t1, res_full_t1)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

```{r}
boxcox(mlr_transform_first, lambda=seq(0,3, 0.01))
```