---
title: "Project"
author: "Hyun Suk (Max) Ryoo (hr2ee)"
date: "11/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
## Data Processing
library(tidyverse)
library(dplyr)
library(MASS)
library(leaps)
setwd("/Users/maxryoo/Documents/MSDS/STAT6021/Project2")
data <- read.csv("data/insurance.csv")
head(data)
```

```{r}
data$significant.charge = as.factor(data$charges > median(data$charges))
data$smoker = as.factor(data$smoker)
data$region = as.factor(data$region)
head(data)
```
```{r}
ggplot(aes(x=bmi, y=charges, color=smoker), data=data) + 
  labs(title="Scatter Plot of Charges vs BMI by Smoker Status") +
  theme_bw() +
  geom_point()
```

```{r}
ggplot(aes(x=age,y=charges, color=smoker, size=bmi), data=data) + 
  labs(title="Scatter plot of Charges vs Age by BMI and Smoker Status") +
  theme_bw() +
  geom_point(alpha=0.5)
```

```{r}
ggplot(aes(x=age,y=bmi, color=significant.charge), data=data) + 
  labs(title="Scatter plot of Charges vs Age by BMI and Smoker Status") +
  theme_bw() +
  geom_point(alpha=0.5)
```

```{r}
ggplot(data, aes(x=region, y=age, fill=as.factor(significant.charge)))+
  geom_boxplot() +
  theme_bw() +
  labs(x="region", y="ages", title="Dist of bmi by region and smoker status")
```

```{r}
ggplot(data, aes(x=smoker, y=bmi, fill=as.factor(significant.charge)))+
  geom_boxplot() +
  theme_bw() +
  labs(x="Region", y="bmi", title="Distribution of bmi by region and smoker status") +  scale_y_continuous(limits=c(10,60), breaks=seq(10,60,5)) 
```


## Correlation

```{r}
pairs(data[c("age", "bmi", "charges")])
```

```{r}
round(cor(data[c("age", "bmi", "charges")]),4)
```
## All possible regressions and pull based on adjusted R square, mallow, and BIC

```{r}
no_class_predictor = data[1:7]
allreg2 <- regsubsets(charges ~., data=no_class_predictor, nbest=2)
summary(allreg2)
```

## Best for Adjusted R square
```{r}
coef(allreg2, which.max(summary(allreg2)$adjr2))
```

## Best for Mallows 
```{r}
coef(allreg2, which.min(summary(allreg2)$cp))
```

## Best for BIC
```{r}
coef(allreg2, which.min(summary(allreg2)$bic))
```


## Forward Selection
```{r}
##intercept only model
regnull <- lm(charges~1, data=no_class_predictor)
##model with all predictors
regfull <- lm(charges ~ . , data=no_class_predictor)
```

Forward Selection
```{r}
step(regnull, scope=list(lower=regnull, upper=regfull), direction="forward")
```
    (Intercept)             age             bmi        children       smokeryes regionsoutheast 
    -12165.3824        257.0064        338.6413        471.5441      23843.8749       -858.4696 
regionsouthwest 
      -782.7452 

## Backwards
```{r}
step(regfull, scope=list(lower=regnull, upper=regfull), direction="backward")
```


## Based on forward and backward 

We get the same model for forward and backward

Let's first make a multiple linear regression model with all the predictors.

```{r}
mlr_full = lm(charges ~  age + bmi + children + smoker + region, data=data)
summary(mlr_full)
```
The full regression is as follows.

$$
\hat{y} = -11938.5 + 256.9\text{age} -131.3I_1 + 339.2\text{bmi} + 475.5\text{children} + 23848.5I_2 - 353.0I_3 - 1035.0I_4 - 960.0I_5
$$

$I_1$ indicates whether the sex of the client is male. The value will be 0 for females. $I_2$ indicates whether that a client smokes. The value will be 0 for non smokers. $I_3$ indicates that the client is in the northwest region. $I_4$ indicates that the client is located in the southeast. $I_5$ indicates that the client is located inthe southwest. If the client is in the northeast $I_3, I_4, I_5$ will be zero, since this is the reference class. 

## Assumption Check of Full Model
```{r}
yhat_full <- mlr_full$fitted.values
res_full <- mlr_full$residuals
data %>%
  ggplot(aes(yhat_full, res_full)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

The residuals are obviously not evenly scattered, which then we can utilize the boxcox method to give us information about transformation.

```{r}
boxcox(mlr_full, lambda=seq(0,0.3, 0.01))
```

From the boxcox we can try a lambda value of 0.15 for transformation.

QQPlot

```{r}
{
  qqnorm(mlr_full$residuals)
  qqline(mlr_full$residuals, col="red")
}
```

ACF

```{r}
acf(mlr_full$residuals, main="ACF")
```

```{r}
first_transformation_full <- data
first_transformation_full$charges <- first_transformation_full$charges^0.15
mlr_transform_first <- lm(charges ~ age + bmi + children + smoker + region, data=first_transformation_full)
summary(mlr_transform_first)
```

Residual Plot of the transformed model.

```{r}
yhat_full_t1 <- mlr_transform_first$fitted.values
res_full_t1 <- mlr_transform_first$residuals
data %>%
  ggplot(aes(yhat_full_t1, res_full_t1)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

Violation in constant variance

```{r}
boxcox(mlr_transform_first, lambda=seq(0,3, 0.01))
```

QQPLOT

```{r}
{
  qqnorm(mlr_transform_first$residuals)
  qqline(mlr_transform_first$residuals, col="red")
}
```

## Externally Studentized Residuals

```{r}
res<-mlr_transform_first$residuals
standard.res<-res/summary(mlr_transform_first)$sigma
student.res <- rstandard(mlr_transform_first)
ext.student.res<-rstudent(mlr_transform_first)
res.frame<-data.frame(res,standard.res, student.res,ext.student.res)
```

## Outlier Detection
```{r}
summary(mlr_transform_first)
```


```{r}
n = dim(data)[1]
p = 8
crit<-qt(1-0.05/(2*n), n-p-1)
ext.student.res[abs(ext.student.res)>crit]
```


## Possible Leverages
```{r}
lev<-lm.influence(mlr_transform_first)$hat
##identify high leverage points
lev[lev>2*p/n]
```


## Influential Observations

```{r}
COOKS<-cooks.distance(mlr_transform_first)
COOKS[COOKS>qf(0.5,p,n-p)]
```

## DFFITs
```{r}
DFFITS<-dffits(mlr_transform_first)
DFFITS[abs(DFFITS)>2*sqrt(p/n)]
```


## DFBETAs
```{r}
##dfbetas
DFBETAS<-dfbetas(mlr_transform_first)
DFBETAS[abs(DFBETAS[,1])>2/sqrt(n),1]
```

```{r}
DFBETAS[abs(DFBETAS[,1])>2/sqrt(n),2]
```


## Why is this happening? Is there some weird behavior in the response variable?

```{r}
hist(data$charges)
```

```{r}
hist(first_transformation_full$charges)
```


## Trial of other predictors to fullfill the linearity assumption.

Maybe we can add some interaction terms to the model to see if we can fix the linearity assumption.

```{r}
interaction_age_bmi_with_smoker = lm(charges ~  age*smoker + bmi*smoker + children  + region, data=data)
summary(interaction_age_bmi_with_smoker)
```

Residual Plot
```{r}
yhat_full_first_inter <- interaction_age_bmi_with_smoker$fitted.values
res_full_first_inter <- interaction_age_bmi_with_smoker$residuals
data %>%
  ggplot(aes(yhat_full_first_inter, res_full_first_inter)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

This residual plot is a little better, lets see if we can transform the response with this new equation.

```{r}
boxcox(interaction_age_bmi_with_smoker, lambda=seq(0,0.3, 0.01))
```

Maybe we can use a lambda value of 0.125

```{r}
interaction_transform <- data
interaction_transform$charges <- interaction_transform$charges^0.125
mlr_interaction_tranform <- lm(charges ~  age*smoker + bmi*smoker + children  + region, data=interaction_transform)
summary(mlr_interaction_tranform)
```

Recheck Residual Plot

```{r}
yhat_full_first_inter_tranform <- mlr_interaction_tranform$fitted.values
res_full_first_inter_tranform <- mlr_interaction_tranform$residuals
data %>%
  ggplot(aes(yhat_full_first_inter_tranform, res_full_first_inter_tranform)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

Still see the same without adding the interaction terms.

```{r}
boxcox(mlr_interaction_tranform, lambda=seq(0,3, 0.01))
```


Still no luck. We retried this many times, but weren't lucky.

## Partial F test of the interaction vs simple model after two transformation of response variable
```{r}
full <- mlr_interaction_tranform
reduced <- lm(charges ~ age + bmi + children + smoker + region, data=interaction_transform)
anova(reduced, full)
```

We can't drop the interaction terms.

## BIC Model selection model might be better

```{r}
bic_selection_model = lm(charges ~  age + bmi + children  + smoker, data=data)
summary(bic_selection_model)
```

Residual Plot

```{r}
yhat_bic <- bic_selection_model$fitted.values
res_bic <- bic_selection_model$residuals
data %>%
  ggplot(aes(yhat_bic, res_bic)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

We see a similar plot. Transformation?

```{r}
boxcox(bic_selection_model, lambda=seq(0,0.3, 0.01))
```

Again lambda of 0.15

```{r}
bic_transform <- data
bic_transform$charges <- bic_transform$charges^(0.15)
bic_selection_model_transform = lm(charges ~  age + bmi + children  + smoker, data=bic_transform)
summary(bic_selection_model_transform)
```

Residual Plot

```{r}
yhat_bic_transform <- bic_selection_model_transform$fitted.values
res_bic_transform <- bic_selection_model_transform$residuals
data %>%
  ggplot(aes(yhat_bic_transform, res_bic_transform)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

Same Stuff happening.

```{r}
boxcox(bic_selection_model_transform, lambda=seq(0,3, 0.01))
```

QQPlot
```{r}
{
  qqnorm(bic_selection_model_transform$residuals)
  qqline(bic_selection_model_transform$residuals, col="red")
}
```

## Change the data split the data ?
```{r}
less_charge <- data[data$charges < 20000,]
more_change <- data[data$charges >= 20000, ]
library(tidyverse)
ggplot(aes(x=bmi, y=charges, color=smoker), data=less_charge) + 
  labs(title="Scatter Plot of Charges vs BMI by Smoker Status") +
  theme_bw() +
  geom_point()
ggplot(aes(x=age,y=charges, color=smoker, size=bmi), data=less_charge) + 
  labs(title="Scatter plot of Charges vs Age by BMI and Smoker Status") +
  theme_bw() +
  geom_point(alpha=0.5)

ggplot(aes(x=bmi, y=charges, color=smoker), data=more_change) + 
  labs(title="Scatter Plot of Charges vs BMI by Smoker Status") +
  theme_bw() +
  geom_point()
ggplot(aes(x=age,y=charges, color=smoker, size=bmi), data=more_change) + 
  labs(title="Scatter plot of Charges vs Age by BMI and Smoker Status") +
  theme_bw() +
  geom_point(alpha=0.5)
```

```{r}
pairs(more_change[c("age", "bmi", "charges")])
pairs(less_charge[c("age", "bmi", "charges")])
```
```{r}
mlr_full_smoker = lm(charges ~  (age + bmi + children + region) * smoker, data=data)
summary(mlr_full_smoker)
```

## Assumption Check of Full Model
```{r}
yhat_full_smoker <- mlr_full_smoker$fitted.values
res_full_smoker <- mlr_full_smoker$residuals
data %>%
  ggplot(aes(yhat_full_smoker, res_full_smoker)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

The residuals are obviously not evenly scattered, which then we can utilize the boxcox method to give us information about transformation.

```{r}
boxcox(mlr_full_smoker, lambda=seq(0,0.3, 0.01))
```

From the boxcox we can try a lambda value of 0.1 for transformation.

```{r}
interaction_transform_smoker <- data
interaction_transform_smoker$charges <- interaction_transform_smoker$charges^0.1
mlr_interaction_tranform_smoker <- lm(charges ~  (age + bmi + children + region) * smoker, data=interaction_transform_smoker)
summary(mlr_interaction_tranform_smoker)
```

```{r}
yhat_full_smoker <- mlr_interaction_tranform_smoker$fitted.values
res_full_smoker <- mlr_interaction_tranform_smoker$residuals
data %>%
  ggplot(aes(yhat_full_smoker, res_full_smoker)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```


Lets SPLIT BY SMOKERS

```{r}
smokers <- data[data$smoker == 'yes',]
non_smokers <- data[data$smoker != 'yes',]
```

```{r}
## Smokers
##intercept only model
regnull_smoker <- lm(charges~1, data=smokers)
##model with all predictors
regfull_smoker <- lm(charges ~ age + sex + bmi + children + region , data=smokers)
```

Forward Selection
```{r}
step(regnull_smoker, scope=list(lower=regnull_smoker, upper=regfull_smoker), direction="forward")
```

```{r}
#Non smokers
regnull_non_smokers <- lm(charges~1, data=non_smokers)
##model with all predictors
regfull_non_smokers <- lm(charges ~ age + sex + bmi + children + region , data=non_smokers)
```

Forward Selection
```{r}
step(regnull_non_smokers, scope=list(lower=regnull_non_smokers, upper=regfull_non_smokers), direction="forward")
```

## We get different models

```{r}
mlr_full_smoker = lm(charges ~  bmi+age , data=smokers)
summary(mlr_full_smoker)
```


```{r}
yhat_full_smoker <- mlr_full_smoker$fitted.values
res_full_smoker <- mlr_full_smoker$residuals
smokers %>%
  ggplot(aes(yhat_full_smoker, res_full_smoker)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

```{r}
boxcox(mlr_full_smoker)
```

Rseponse needs to be transformed 

```{r}
smokers_transform <- smokers
smokers_transform$charges <- smokers_transform$charges^0.5
mlr_full_smoker_transform = lm(charges ~  bmi+age , data=smokers_transform)
summary(mlr_full_smoker_transform)
```

residual plot

```{r}
yhat_full_smoker <- mlr_full_smoker_transform$fitted.values
res_full_smoker <- mlr_full_smoker_transform$residuals
smokers %>%
  ggplot(aes(yhat_full_smoker, res_full_smoker)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

```{r}
boxcox(mlr_full_smoker_transform)
```

QQPlot

```{r}
{
  qqnorm(mlr_full_smoker_transform$residuals)
  qqline(mlr_full_smoker_transform$residuals, col="red")
}
```

ACF

```{r}
acf(mlr_full_smoker_transform$residuals, main="ACF")
```



## Non Smokers
```{r}
mlr_full_non_smoker = lm(formula = charges ~ age + children + region + sex, data = non_smokers)
summary(mlr_full_non_smoker)
```

```{r}
yhat_full_non_smoker <- mlr_full_non_smoker$fitted.values
res_full_non_smoker <- mlr_full_non_smoker$residuals
non_smokers %>%
  ggplot(aes(yhat_full_non_smoker, res_full_non_smoker)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```

Transformation
```{r}
boxcox(mlr_full_non_smoker, c(-0.5, 0.5, 0.1))
```

```{r}
non_smoker_transform <- non_smokers
non_smoker_transform$charges <- non_smoker_transform$charges^(-0.1)
mlr_full_non_smoker_transform = lm(formula = charges ~ age + children + region + sex, data = non_smoker_transform)
summary(mlr_full_non_smoker_transform)
```

```{r}
yhat_full_non_smoker <- mlr_full_non_smoker_transform$fitted.values
res_full_non_smoker <- mlr_full_non_smoker_transform$residuals
non_smokers %>%
  ggplot(aes(yhat_full_non_smoker, res_full_non_smoker)) + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="red")
```


```{r}
boxcox(mlr_full_non_smoker_transform)
```

QQPlot

```{r}
{
  qqnorm(mlr_full_non_smoker_transform$residuals)
  qqline(mlr_full_non_smoker_transform$residuals, col="red")
}
```

ACF

```{r}
acf(mlr_full_smoker_transform$residuals, main="ACF")
```

```{r}
head(non_smokers)
```
```{r}
# charges ~ age + children + region + sex
non_smokers %>%
  ggplot(aes(x=age, y=charges)) + 
  theme_bw() +
  geom_point(alpha=0.5)
```

## Next Steps
We need to find for non smokers what is causing some data points to be more charges...?
```{r}
non_smokers %>%
  ggplot(aes(x=age, y=charges, size=children, color=region)) + 
  theme_bw() +
  geom_point(alpha=0.5)
```


## Logistic
```{r}
set.seed(6021) ##for reproducibility
sample<-sample.int(nrow(data), floor(.50*nrow(data)), replace = F)
train<- data[sample, ] ##training data frame
test<-data[-sample, ] ##test data frame
result<-glm(significant.charge ~ age + bmi + children + smoker + region, family="binomial", data=train)
summary(result)
```

```{r}
library(ROCR)
##predicted survival rate for test data based on training data
preds<-predict(result,newdata=test, type="response")
##transform the input data into a format that is suited for the
##performance() function
rates<-prediction(preds, test$significant.charge)
##store the true positive and false positive rates
roc_result<-performance(rates,measure="tpr", x.measure="fpr")
##plot ROC curve and overlay the diagonal line for random guessing
plot(roc_result, main="ROC Curve")
lines(x = c(0,1), y = c(0,1), col="red")
```


```{r}
##compute the AUC
auc<-performance(rates, measure = "auc")
auc@y.values
```


Matrix
```{r}
table(test$significant.charge, preds>0.5)
```

Threshold value manipulation
```{r}
table(test$significant.charge, preds>0.2)
```
Doesn't play a huge role in decreasing the False Positive Rate. We want to make sure that when someone signs up for a plan that they don't get charged significantly given their condition.
